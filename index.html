<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿åŒ—å‹¤å‹™æ‰“å¡ç³»çµ±</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/6148f9_56377cef73c1498f95a2c3057b89f2ed~mv2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .main-container {
            width: 400px;
            height: 750px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
        }
        .hide { display: none !important; }
        .tab-btn.active {
            color: #dc2626; /* red-600 */
            border-top-color: #dc2626; /* red-600 */
        }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sub-tab-btn.active {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626; /* red-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        /* Ensure map canvas is visible */
        .map-canvas {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* Gray background as a fallback */
        }
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 9999px;
            color: white;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            opacity: 1;
            bottom: 110px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- API Key Warning -->
    <div id="api-key-warning" class="hide fixed inset-0 bg-red-100 z-[9999] p-8 text-red-800 flex flex-col items-center justify-center text-center">
        <i data-lucide="alert-triangle" class="w-16 h-16 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">è«‹å®Œæˆæœ€å¾Œçš„è¨­å®šæ­¥é©Ÿ</h2>
        <p class="max-w-md">
            ç³»çµ±åµæ¸¬åˆ°æ‚¨å°šæœªè¨­å®š Firebase æˆ– Google Maps çš„ API é‡‘é‘°ã€‚
            <br><br>
            <strong class="text-red-900">é€™ä¸æ˜¯ç¨‹å¼éŒ¯èª¤ï¼Œè€Œæ˜¯å¿…è¦çš„è¨­å®šã€‚</strong> åŸºæ–¼å®‰å…¨è€ƒé‡ï¼Œæˆ‘ç„¡æ³•ç‚ºæ‚¨ç”¢ç”Ÿé‡‘é‘°ï¼Œæ‚¨å¿…é ˆè¦ªè‡ªå®Œæˆæ­¤è¨­å®šã€‚
            <br><br>
            è«‹æ‰“é–‹ <code>index.html</code> æª”æ¡ˆï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹çš„ <code>&lt;script type="module"&gt;</code> å€å¡Šï¼Œä¸¦ä¾ç…§è¨»è§£æŒ‡ç¤ºå¡«å…¥æ‚¨è‡ªå·±çš„é‡‘é‘°ã€‚è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒ <code>README.md</code> æª”æ¡ˆã€‚
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">è¥¿åŒ—å‹¤å‹™æ‰“å¡ç³»çµ±</h1>
            <p class="text-gray-500">é›²ç«¯æ¸¬è©¦ç‰ˆV1.2.1</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶</label>
                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
            </div>
            <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                ç™»å…¥
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="main-container bg-white flex flex-col hide">
        <!-- Header -->
        <header class="h-[70px] flex items-center justify-between px-4 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <span class="text-lg font-bold text-gray-800">è¥¿åŒ—å‹¤å‹™æ‰“å¡ç³»çµ±</span>
            </div>
            <button id="profile-avatar-btn">
                <img id="header-avatar" src="https://placehold.co/40x40/EFEFEF/333333?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col overflow-hidden bg-gray-50">
            <!-- This will be dynamically populated -->
        </main>

        <!-- Footer Navigation -->
        <footer class="h-[70px] border-t border-gray-200 flex-shrink-0 bg-white">
            <nav id="main-nav" class="flex justify-around h-full items-center">
                <button data-tab="dashboard" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 active">
                    <i data-lucide="layout-dashboard"></i><span class="text-xs mt-1">å„€è¡¨æ¿</span>
                </button>
                <button data-tab="clock-in" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="fingerprint"></i><span class="text-xs mt-1">æ‰“å¡</span>
                </button>
                <button id="nav-tracking" data-tab="tracking" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="map-pin"></i><span class="text-xs mt-1">è¿½è¹¤</span>
                </button>
                <button id="nav-settings" data-tab="settings" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="settings"></i><span class="text-xs mt-1">è¨­å®š</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>


    <script type="module">
        // --- ğŸš¨ é‡è¦è¨­å®šï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨è‡ªå·±çš„ API é‡‘é‘° ğŸš¨ ---
        const firebaseConfig = {
          apiKey: "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg",
          authDomain: "nw-check-in.firebaseapp.com",
          projectId: "nw-check-in",
          storageBucket: "nw-check-in.appspot.com",
          messagingSenderId: "1060821780559",
          appId: "1:1060821780559:web:2638d630526d54f1a5023a",
          measurementId: "G-61Q1QNNRD2"
        };
        const GOOGLE_MAPS_API_KEY = "AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY";
        // --- ğŸš¨ è¨­å®šçµæŸ ğŸš¨ ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot,
            query, where, getDocs, serverTimestamp, orderBy, GeoPoint, Timestamp, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Global State
        const state = {
            currentUser: null,
            currentUserData: null,
            googleMapsLoaded: false,
            activeListeners: [],
            currentLocation: null,
            users: [], 
        };
        
        const loadingScreen = document.getElementById('loading-screen');
        
        function showLoading(show) {
            if(loadingScreen) loadingScreen.classList.toggle('hide', !show);
        }

        function initializeAppLogic() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const mainContent = document.getElementById('main-content');
            const mainNav = document.getElementById('main-nav');
            const profileAvatarBtn = document.getElementById('profile-avatar-btn');
            const modalContainer = document.getElementById('modal-container');
            const toast = document.getElementById('toast');
            const loginForm = document.getElementById('login-form');
            const bodyEl = document.body;

            // --- Authentication Logic ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');
                loginError.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚';
                } finally {
                    showLoading(false);
                }
            });
            
            onAuthStateChanged(auth, (user) => {
                cleanupListeners();
                if (user) {
                    bodyEl.classList.remove('bg-red-600');
                    bodyEl.classList.add('bg-gray-100');
                    state.currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const wasNotInitialized = !state.currentUserData;
                            state.currentUserData = { id: user.uid, ...docSnap.data() };
                            if (wasNotInitialized) {
                                initializeAppUI();
                            } else {
                                updateHeaderAvatar();
                            }
                        } else { signOut(auth); }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        signOut(auth);
                    });
                    state.activeListeners.push(unsubscribe);
                } else {
                    bodyEl.classList.remove('bg-gray-100');
                    bodyEl.classList.add('bg-red-600');
                    state.currentUser = null;
                    state.currentUserData = null;
                    loginPage.classList.remove('hide');
                    appContainer.classList.add('hide');
                    showLoading(false);
                }
            });

            // --- UI Initialization and Navigation ---
            function initializeAppUI() {
                loadGoogleMapsScript();
                updateHeaderAvatar();
                
                const navTracking = document.getElementById('nav-tracking');
                const navSettings = document.getElementById('nav-settings');

                if (state.currentUserData.role !== 'admin') {
                    navTracking.classList.add('hide');
                    navSettings.classList.add('hide');
                } else {
                    navTracking.classList.remove('hide');
                    navSettings.classList.remove('hide');
                    fetchAllUsers(); 
                }
                
                loginPage.classList.add('hide');
                appContainer.classList.remove('hide');
                
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-btn[data-tab="dashboard"]').classList.add('active');
                
                showPage('dashboard');
                showLoading(false);
            }

            function updateHeaderAvatar() {
                const headerAvatar = document.getElementById('header-avatar');
                if (state.currentUserData?.avatarUrl) {
                    headerAvatar.src = state.currentUserData.avatarUrl;
                } else {
                    headerAvatar.src = `https://placehold.co/40x40/EFEFEF/333333?text=${state.currentUserData?.name?.charAt(0) || 'U'}`;
                }
            }

            mainNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-btn');
                if (tabButton && !tabButton.classList.contains('active')) {
                    showPage(tabButton.dataset.tab);
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    tabButton.classList.add('active');
                }
            });

            profileAvatarBtn.addEventListener('click', renderProfileModal);

            function showPage(pageName, subPage = null, params = {}) {
                cleanupListeners();
                state.currentLocation = null;
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const router = {
                    'dashboard': renderDashboard,
                    'clock-in': () => renderClockIn(subPage || 'location'),
                    'tracking': () => state.currentUserData.role === 'admin' ? renderTracking(subPage || 'locate') : renderAccessDenied(),
                    'settings': () => state.currentUserData.role === 'admin' ? renderSettings(subPage || 'accounts') : renderAccessDenied()
                };
                const renderFunction = router[pageName] || renderAccessDenied;
                try {
                    renderFunction(params);
                } catch(e) {
                    console.error("Failed to render page:", e);
                    mainContent.innerHTML = `<div class="p-4 text-red-500">é é¢è¼‰å…¥å¤±æ•—ã€‚</div>`;
                }
                lucide.createIcons();
            }

            function renderAccessDenied() {
                mainContent.innerHTML = `
                    <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <i data-lucide="ban" class="w-16 h-16 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold">æ¬Šé™ä¸è¶³</h2>
                        <p>æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ã€‚</p>
                    </div>
                `;
            }

            // --- Page Render Functions ---
            
            function renderDashboard() {
                 mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-center border-b border-gray-200 bg-white">
                         <p id="current-time" class="text-lg font-semibold text-gray-700"></p>
                    </div>
                    <div class="p-4 overflow-y-auto" style="height: calc(100% - 50px);">
                        <div class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                            <h3 class="font-bold text-red-800 mb-2 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i>æˆ‘çš„ç‹€æ…‹</h3>
                            <div id="my-status" class="text-gray-600">è®€å–ä¸­...</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i>æ‰€æœ‰å“¡å·¥ç‹€æ…‹</h3>
                            <div id="all-users-status" class="space-y-2">
                               <div class="text-center p-4 text-gray-500">è®€å–ä¸­...</div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                const timeEl = document.getElementById('current-time');
                const timerInterval = setInterval(() => {
                    if(timeEl){ timeEl.textContent = new Date().toLocaleString('zh-TW', { dateStyle: 'long', timeStyle: 'medium' }); }
                }, 1000);
                state.activeListeners.push(() => clearInterval(timerInterval));
                
                const usersRef = collection(db, "users");
                const unsubscribe = onSnapshot(query(usersRef), (querySnapshot) => {
                    const allUsersStatusEl = document.getElementById('all-users-status');
                    if(!allUsersStatusEl) return;
                    allUsersStatusEl.innerHTML = '';
                    let myStatusFound = false;
                    const users = [];
                    querySnapshot.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                    users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                        const statusText = user.status || 'æœªæ‰“å¡';
                        const statusColor = getStatusColor(statusText);
                        if (user.id === state.currentUser.uid) {
                            myStatusFound = true;
                            document.getElementById('my-status').innerHTML = `
                              <div class="flex items-center justify-between">
                                <span class="font-semibold text-lg ${statusColor}">${statusText}</span>
                                <span class="text-sm text-gray-500">${user.lastClockInTime ? 'ä¸Šæ¬¡: ' + new Date(user.lastClockInTime.toDate()).toLocaleTimeString('zh-TW') : ''}</span>
                              </div>`;
                        }
                        allUsersStatusEl.innerHTML += `
                            <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm border">
                                <div class="flex items-center"><img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover"><span class="font-medium text-gray-700">${user.name}</span></div>
                                <span class="text-sm font-semibold ${statusColor}">${statusText}</span>
                            </div>`;
                    });
                    if(!myStatusFound && document.getElementById('my-status')){ document.getElementById('my-status').textContent = 'ç„¡æ³•å–å¾—æ‚¨çš„ç‹€æ…‹'; }
                });
                state.activeListeners.push(unsubscribe);
            }

            function renderClockIn(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="location" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'location' ? 'active' : ''}">å®šä½æ‰“å¡</button>
                        <button data-subtab="records" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'records' ? 'active' : ''}">æ‰“å¡ç´€éŒ„</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'location') {
                    renderClockInLocation(subPageContent);
                } else if (subPage === 'records') {
                    renderClockInRecords(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('clock-in', btn.dataset.subtab)));
            }

            function renderClockInLocation(container) {
                container.innerHTML = `
                    <div class="p-4 h-full flex flex-col">
                        <button id="relocate-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 flex items-center justify-center mb-4">
                            <i data-lucide="locate-fixed" class="w-4 h-4 mr-2"></i>é‡æ–°å®šä½
                        </button>
                        <div id="map-container" class="flex-grow rounded-lg overflow-hidden border border-gray-300 relative">
                             <div id="map" class="map-canvas"></div>
                             <div id="map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-4">
                            <button data-type="ä¸Šç­" class="clock-in-btn bg-green-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-green-600">ä¸Šç­æ‰“å¡</button>
                            <button data-type="ä¸‹ç­" class="clock-in-btn bg-gray-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-gray-600">ä¸‹ç­æ‰“å¡</button>
                            <button data-type="å¤–å‡º" class="clock-in-btn bg-blue-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-600">å¤–å‡ºæ‰“å¡</button>
                            <button data-type="è¿”å›" class="clock-in-btn bg-teal-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-teal-600">è¿”å›æ‰“å¡</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initClockInMap();

                document.getElementById('relocate-btn').addEventListener('click', initClockInMap);
                document.querySelectorAll('.clock-in-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (!state.currentLocation) {
                            showToast("ç„¡æ³•å–å¾—ç›®å‰ä½ç½®ï¼Œè«‹ç¨å¾Œå†è©¦", true);
                            return;
                        }
                        const type = e.target.dataset.type;
                        openCameraModal(type, state.currentLocation);
                    });
                });
            }

            function renderClockInRecords(container) {
                 const today = new Date().toISOString().split('T')[0];
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="record-date" class="text-sm font-medium">ç¯©é¸æ—¥æœŸ:</label>
                            <input type="date" id="record-date" value="${today}" class="border border-gray-300 rounded-md px-2 py-1">
                        </div>
                        <div id="records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>
                        </div>
                    </div>
                `;

                const dateInput = document.getElementById('record-date');
                const loadRecords = () => {
                    const selectedDate = new Date(dateInput.value);
                    const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0));
                    const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999));
                    
                    const recordsRef = collection(db, "clockInRecords");
                    const q = query(recordsRef, 
                        where("userId", "==", state.currentUser.uid),
                        where("timestamp", ">=", startOfDay),
                        where("timestamp", "<=", endOfDay),
                        orderBy("timestamp", "desc")
                    );

                    const unsubscribe = onSnapshot(q, (querySnapshot) => {
                        const recordsListEl = document.getElementById('records-list');
                        if (!recordsListEl) return;
                        recordsListEl.innerHTML = '';
                        if (querySnapshot.empty) {
                            recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æ—¥ç„¡æ‰“å¡ç´€éŒ„</p>`;
                            return;
                        }
                        
                        // å°†æŸ¥è¯¢ç»“æœè½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ—¶é—´æ’åºï¼ˆä»æ–°åˆ°æ—§ï¼‰
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // æŒ‰æ—¶é—´ä»æ–°åˆ°æ—§æ’åº
                        records.sort((a, b) => {
                            const timeA = a.timestamp?.toDate?.() || new Date(0);
                            const timeB = b.timestamp?.toDate?.() || new Date(0);
                            return timeB - timeA; // é™åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰
                        });
                        
                        // æ¸²æŸ“æ‰€æœ‰è®°å½•
                        records.forEach(record => {
                            const card = document.createElement('div');
                            card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
                            const statusColor = getStatusColor(record.type);
                            card.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg ${statusColor}">${record.type}</p>
                                        <p class="text-sm text-gray-600">${formatDate(record.timestamp)}</p>
                                    </div>
                                    <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                        <i data-lucide="map-pin"></i> åœ°åœ–
                                    </button>
                                </div>
                                <div class="mt-2 flex space-x-2 overflow-x-auto">
                                    <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${JSON.stringify(record.photoUrls || [])}' 
                                        data-descriptions='${JSON.stringify(record.descriptions || [])}'>
                                        <i data-lucide="image"></i> ç…§ç‰‡ (${record.photoUrls?.length || record.descriptions?.length || 0})
                                    </button>
                                </div>
                            `;
                            recordsListEl.appendChild(card);
                            // Init small map
                            if (state.googleMapsLoaded && record.location) {
                                new google.maps.Map(document.getElementById(`map-${record.id}`), {
                                    center: { lat: record.location.latitude, lng: record.location.longitude },
                                    zoom: 15,
                                    disableDefaultUI: true,
                                });
                            }
                        });
                    });
                    state.activeListeners.push(unsubscribe);
                    
                    // æ·»åŠ åœ°åœ–æŒ‰éˆ•é»æ“Šäº‹ä»¶
                    setTimeout(() => {
                        document.querySelectorAll('.map-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const lat = parseFloat(e.currentTarget.dataset.lat);
                                const lng = parseFloat(e.currentTarget.dataset.lng);
                                openMapModal(lat, lng);
                            });
                        });
                        
                        // æ·»åŠ ç…§ç‰‡æŒ‰éˆ•é»æ“Šäº‹ä»¶
                        document.querySelectorAll('.photo-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const photos = JSON.parse(e.currentTarget.dataset.photos);
                                const descriptions = JSON.parse(e.currentTarget.dataset.descriptions);
                                openPhotoModal(photos, descriptions);
                            });
                        });
                    }, 500); // å»¶è¿Ÿæ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿DOMå…ƒç´ å·²å®Œå…¨åŠ è½½
                    
                    // æ›´æ–°Lucideåœ–æ¨™
                    lucide.createIcons();
                };

                dateInput.addEventListener('change', loadRecords);
                loadRecords();
            }

            async function initClockInMap() {
                const mapLoader = document.getElementById('map-loader');
                const mapDiv = document.getElementById('map');
                if(!mapDiv || !mapLoader) return;
                
                mapLoader.classList.remove('hide');
                state.currentLocation = null;
                
                // ç¢ºä¿Google Maps APIå·²åŠ è¼‰
                if (!window.google || !window.google.maps) {
                    console.log("ç­‰å¾…Google Maps APIåŠ è¼‰...");
                    loadGoogleMapsScript(); // å˜—è©¦é‡æ–°åŠ è¼‰
                    setTimeout(initClockInMap, 1000); // å»¶é²é‡è©¦
                    return;
                }
                
                console.log("é–‹å§‹åˆå§‹åŒ–åœ°åœ–...");
                
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 0 
                        });
                    });
                    
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    state.currentLocation = coords;
                    
                    console.log("ç²å–ä½ç½®æˆåŠŸ:", coords);
                    
                    // ç¢ºä¿åœ°åœ–å®¹å™¨æœ‰é©ç•¶çš„å°ºå¯¸
                    if (mapDiv.offsetWidth === 0 || mapDiv.offsetHeight === 0) {
                        mapDiv.style.width = '100%';
                        mapDiv.style.height = '300px';
                    }
                    
                    const map = new google.maps.Map(mapDiv, { 
                        center: coords, 
                        zoom: 17, 
                        disableDefaultUI: true 
                    });
                    
                    new google.maps.Marker({ 
                        position: coords, 
                        map: map 
                    });
                    
                    mapLoader.classList.add('hide');
                    console.log("åœ°åœ–åˆå§‹åŒ–æˆåŠŸ");
                } catch (error) {
                    console.error("åˆå§‹åŒ–åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    mapDiv.innerHTML = `<div class="p-4 text-center text-red-500">ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™ã€‚</div>`;
                    mapLoader.classList.add('hide');
                    showToast("ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™", true);
                }
            }


            function renderTracking(subPage) {
                mainContent.innerHTML = `<div class="p-4">è¿½è¹¤åŠŸèƒ½å¾…å¯¦ç¾</div>`;
            }

            function renderSettings(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">å¸³è™Ÿåˆ—è¡¨</button>
                        <button data-subtab="rules" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'rules' ? 'active' : ''}">è¨ˆé»è¦å‰‡</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else if (subPage === 'rules') {
                    renderSettingsRules(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('settings', btn.dataset.subtab)));
            }
            
            async function renderSettingsAccounts(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-user-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢å¸³è™Ÿ
                        </button>
                        <div id="user-list" class="space-y-2"></div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());

                const userList = document.getElementById('user-list');
                await fetchAllUsers();
                userList.innerHTML = '';
                state.users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                    userElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                            <div>
                                <p class="font-medium text-gray-800">${user.name}</p>
                                <p class="text-sm text-gray-500">${user.email}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button data-userid="${user.id}" class="edit-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button data-userid="${user.id}" class="delete-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                    userList.appendChild(userElement);
                });
                lucide.createIcons();

                document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userid;
                    const user = state.users.find(u => u.id === userId);
                    openUserModal(user);
                }));

                document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                    const userId = e.currentTarget.dataset.userid;
                    const user = state.users.find(u => u.id === userId);
                    if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${user.name} çš„å¸³è™Ÿå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                        try {
                            showLoading(true);
                            await deleteDoc(doc(db, "users", userId));
                            showToast("å¸³è™Ÿåˆªé™¤æˆåŠŸ");
                            showPage('settings', 'accounts'); 
                        } catch (error) {
                            console.error("Error deleting user:", error);
                            showToast("åˆªé™¤å¤±æ•—", true);
                        } finally {
                            showLoading(false);
                        }
                    }
                }));
            }

            function renderSettingsRules(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-rule-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢è¦å‰‡
                        </button>
                        <div id="rule-list" class="space-y-2">è®€å–ä¸­...</div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-rule-btn').addEventListener('click', () => openRuleModal());

                const ruleList = document.getElementById('rule-list');
                const rulesRef = collection(db, "pointRules");
                const q = query(rulesRef, orderBy("reason"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    ruleList.innerHTML = '';
                    if (querySnapshot.empty) {
                        ruleList.innerHTML = `<p class="text-center text-gray-500 p-4">å°šæœªå»ºç«‹ä»»ä½•è¦å‰‡</p>`;
                        return;
                    }
                    querySnapshot.forEach(doc => {
                        const rule = { id: doc.id, ...doc.data() };
                        const pointsClass = rule.points > 0 ? 'text-green-600' : 'text-red-600';
                        const ruleElement = document.createElement('div');
                        ruleElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        ruleElement.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${rule.reason}</p>
                                <p class="text-sm text-gray-500">å°è±¡: ${rule.target}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg ${pointsClass}">${rule.points > 0 ? '+' : ''}${rule.points}</span>
                                <button data-ruleid="${rule.id}" class="edit-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-ruleid="${rule.id}" class="delete-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        ruleList.appendChild(ruleElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                         const ruleId = e.currentTarget.dataset.ruleid;
                         const ruleDoc = await getDoc(doc(db, "pointRules", ruleId));
                         if (ruleDoc.exists()) {
                            openRuleModal({ id: ruleId, ...ruleDoc.data() });
                         }
                    }));

                    document.querySelectorAll('.delete-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const ruleId = e.currentTarget.dataset.ruleid;
                        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¦å‰‡å—ï¼Ÿ')) {
                            await deleteDoc(doc(db, "pointRules", ruleId));
                            showToast("è¦å‰‡åˆªé™¤æˆåŠŸ");
                        }
                    }));

                });
                state.activeListeners.push(unsubscribe);
            }

            // --- Modals ---
            function openMapModal(lat, lng) {
                const modalId = `map-modal-${Date.now()}`;
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ä½ç½®è³‡è¨Š</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div id="modal-map" class="h-[300px] w-full"></div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                // åˆå§‹åŒ–åœ°åœ–
                if (window.google && window.google.maps) {
                    const mapDiv = document.getElementById('modal-map');
                    const map = new google.maps.Map(mapDiv, {
                        center: { lat, lng },
                        zoom: 17
                    });
                    
                    new google.maps.Marker({
                        position: { lat, lng },
                        map: map
                    });
                } else {
                    document.getElementById('modal-map').innerHTML = 
                        '<div class="p-4 text-center text-red-500">Google Maps å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
                }
            }
            
            function openPhotoModal(photos, descriptions) {
                const modalId = `photo-modal-${Date.now()}`;
                
                let photosHTML = '';
                if (photos && photos.length > 0) {
                    photosHTML = photos.map((url, index) => `
                        <div class="photo-slide">
                            <img src="${url}" class="max-h-[400px] max-w-full object-contain mx-auto" onerror="this.src='https://via.placeholder.com/400x300?text=ç…§ç‰‡è¼‰å…¥å¤±æ•—'">
                            <p class="text-center mt-2 text-gray-600">${descriptions[index] || ''}</p>
                        </div>
                    `).join('');
                } else {
                    photosHTML = '<div class="p-4 text-center text-gray-500">ç„¡ç…§ç‰‡</div>';
                }
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ç…§ç‰‡ç€è¦½</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="p-4 photo-container">
                                ${photosHTML}
                            </div>
                            ${photos.length > 1 ? `
                            <div class="flex justify-center p-2 gap-2">
                                <button class="prev-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">ä¸Šä¸€å¼µ</button>
                                <button class="next-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">ä¸‹ä¸€å¼µ</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                // å¦‚æœæœ‰å¤šå¼µç…§ç‰‡ï¼Œè¨­ç½®è¼ªæ’­åŠŸèƒ½
                if (photos.length > 1) {
                    const slides = modal.querySelectorAll('.photo-slide');
                    let currentSlide = 0;
                    
                    // é¡¯ç¤ºç¬¬ä¸€å¼µç…§ç‰‡ï¼Œéš±è—å…¶ä»–ç…§ç‰‡
                    slides.forEach((slide, index) => {
                        slide.style.display = index === 0 ? 'block' : 'none';
                    });
                    
                    // ä¸Šä¸€å¼µæŒ‰éˆ•
                    modal.querySelector('.prev-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                    
                    // ä¸‹ä¸€å¼µæŒ‰éˆ•
                    modal.querySelector('.next-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide + 1) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                }
            }

            function openUserModal(user = null) {
                // ... Implementation is correct from previous version
            }
            
            function openRuleModal(rule = null) {
                // ... Implementation is correct from previous version
            }

            function renderProfileModal() {
                // ... Implementation is correct from previous version
            }
            
            function openCameraModal(type, location) {
                 const modalId = `camera-modal-${Date.now()}`;
                let videoStream;
                const capturedPhotos = []; // { blob, description }

                const stopCamera = () => {
                    if (videoStream) {
                        videoStream.getTracks().forEach(track => track.stop());
                    }
                };

                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[390px] h-[730px] bg-black rounded-2xl shadow-xl flex flex-col p-4 text-white">
                            <div id="camera-view" class="flex-grow relative flex items-center justify-center">
                                <video id="camera-video" playsinline autoplay class="w-full h-full object-cover rounded-lg"></video>
                                <canvas id="camera-canvas" class="hidden"></canvas>
                                <div id="camera-loader" class="absolute inset-0 flex items-center justify-center bg-black/50"><div class="loader"></div></div>
                            </div>
                            <div id="preview-view" class="hide flex-grow flex flex-col">
                                <img id="photo-preview" class="w-full h-auto flex-grow object-contain rounded-lg">
                                <input type="text" id="photo-description" class="w-full mt-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2" placeholder="è¼¸å…¥èªªæ˜ (30å­—å…§)" maxlength="30">
                            </div>

                            <div class="flex-shrink-0 pt-4">
                                <div id="capture-controls" class="flex items-center justify-between">
                                    <button id="switch-camera-btn" class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center">
                                        <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                                    </button>
                                    <button id="capture-btn" class="w-20 h-20 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center">
                                        <i data-lucide="camera" class="w-10 h-10 text-gray-800"></i>
                                    </button>
                                    <div class="w-12 h-12"></div><!-- ç©ºç™½å…ƒç´ ä¿æŒå°ç¨± -->
                                </div>
                                <div id="confirm-controls" class="hide grid grid-cols-2 gap-2">
                                    <button id="add-another-btn" class="py-3 bg-gray-600 rounded-lg">æ‹ä¸‹ä¸€å¼µ</button>
                                    <button id="finish-btn" class="py-3 bg-red-600 rounded-lg font-semibold">å®Œæˆæ‰“å¡</button>
                                </div>
                            </div>
                             <div class="flex-shrink-0 text-center pt-2">
                                <button id="cancel-camera-btn" class="text-gray-400">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;

                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('camera-canvas');
                const cameraView = document.getElementById('camera-view');
                const previewView = document.getElementById('preview-view');
                const photoPreview = document.getElementById('photo-preview');
                const descriptionInput = document.getElementById('photo-description');
                const captureControls = document.getElementById('capture-controls');
                const confirmControls = document.getElementById('confirm-controls');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
                    .then(stream => {
                        videoStream = stream;
                        video.srcObject = stream;
                        document.getElementById('camera-loader').classList.add('hide');
                        
                        // åˆå§‹åŒ–Lucideåœ–æ¨™
                        lucide.createIcons();
                        
                        // è¨­ç½®ç›¸æ©Ÿåˆ‡æ›æŒ‰éˆ•
                        let currentFacingMode = "environment"; // é è¨­å¾Œé¡é ­
                        document.getElementById('switch-camera-btn').addEventListener('click', async () => {
                            // åœæ­¢ç•¶å‰è¦–è¨Šæµ
                            stopCamera();
                            
                            // é¡¯ç¤ºè¼‰å…¥ä¸­
                            document.getElementById('camera-loader').classList.remove('hide');
                            
                            // åˆ‡æ›å‰å¾Œé¡é ­
                            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
                            
                            try {
                                // ç²å–æ–°çš„è¦–è¨Šæµ
                                const newStream = await navigator.mediaDevices.getUserMedia({ 
                                    video: { facingMode: currentFacingMode }, 
                                    audio: false 
                                });
                                
                                videoStream = newStream;
                                video.srcObject = newStream;
                                document.getElementById('camera-loader').classList.add('hide');
                            } catch (error) {
                                console.error("åˆ‡æ›ç›¸æ©Ÿå¤±æ•—:", error);
                                showToast("åˆ‡æ›ç›¸æ©Ÿå¤±æ•—ï¼Œè«‹é‡è©¦", true);
                                document.getElementById('camera-loader').classList.add('hide');
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Camera error:", err);
                        showToast("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ", true);
                        close();
                    });

                document.getElementById('capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    photoPreview.src = canvas.toDataURL('image/jpeg');
                    cameraView.classList.add('hide');
                    previewView.classList.remove('hide');
                    captureControls.classList.add('hide');
                    confirmControls.classList.remove('hide');
                });
                
                const saveAndPrepareNext = () => {
                    try {
                        // ç¢ºä¿canvasæœ‰å…§å®¹
                        if (!canvas || canvas.width === 0 || canvas.height === 0) {
                            console.error("Canvas is empty or not properly initialized");
                            showToast("ç…§ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦", true);
                            return;
                        }
                        
                        // Apply watermark and save
                        const description = descriptionInput.value;
                        console.log("Applying watermark to canvas:", canvas.width, "x", canvas.height);
                        const watermarkedBlob = applyWatermark(canvas, location, description);
                        
                        if (!watermarkedBlob) {
                            console.error("Failed to create blob from canvas");
                            showToast("ç…§ç‰‡è½‰æ›å¤±æ•—ï¼Œè«‹é‡è©¦", true);
                            return;
                        }
                        
                        capturedPhotos.push({ blob: watermarkedBlob, description });
                        console.log("Photo saved, total photos:", capturedPhotos.length);

                        // Reset for next photo
                        descriptionInput.value = '';
                        cameraView.classList.remove('hide');
                        previewView.classList.add('hide');
                        captureControls.classList.remove('hide');
                        confirmControls.classList.add('hide');
                        showToast(`å·²å„²å­˜ ${capturedPhotos.length} å¼µç…§ç‰‡`);
                    } catch (error) {
                        console.error("Error saving photo:", error);
                        showToast("ç…§ç‰‡å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦", true);
                    }
                };

                document.getElementById('add-another-btn').addEventListener('click', saveAndPrepareNext);

                document.getElementById('finish-btn').addEventListener('click', async () => {
                    try {
                        // å…ˆå„²å­˜ç•¶å‰ç…§ç‰‡
                        const description = descriptionInput.value;
                        if (description || photoPreview.src.includes('data:image')) {
                            saveAndPrepareNext();
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰æˆåŠŸå„²å­˜çš„ç…§ç‰‡
                        if (capturedPhotos.length === 0) {
                            showToast("å¿…é ˆè‡³å°‘æ‹æ”ä¸€å¼µç…§ç‰‡æ‰èƒ½æ‰“å¡", true);
                            return;
                        }
                        
                        stopCamera();
                        showLoading(true);

                        // ç”±æ–¼CORSé™åˆ¶ï¼Œæˆ‘å€‘å°‡ç›´æ¥å„²å­˜æ‰“å¡è¨˜éŒ„ï¼Œä¸ä¸Šå‚³ç…§ç‰‡
                        // é€™æ˜¯ä¸€å€‹è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆï¼Œå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰é…ç½®Firebase Storageçš„CORSè¨­å®š
                        console.log("è·³éç…§ç‰‡ä¸Šå‚³ï¼Œç›´æ¥å„²å­˜æ‰“å¡è¨˜éŒ„");
                        
                        const photoUrls = [];
                        const descriptions = [];
                        
                        // å°‡ç…§ç‰‡æè¿°ä¿å­˜ä¸‹ä¾†ï¼Œä½†ä¸ä¸Šå‚³ç…§ç‰‡
                        for (const photo of capturedPhotos) {
                            if (photo.description) {
                                descriptions.push(photo.description);
                            }
                        }

                        await addDoc(collection(db, "clockInRecords"), {
                            userId: state.currentUser.uid,
                            type: type,
                            timestamp: serverTimestamp(),
                            location: new GeoPoint(location.lat, location.lng),
                            photoUrls: photoUrls,
                            descriptions: descriptions,
                        });

                        await updateDoc(doc(db, "users", state.currentUser.uid), {
                            status: type,
                            lastClockInTime: serverTimestamp()
                        });

                        showToast(`${type}æ‰“å¡æˆåŠŸï¼`);
                        close();
                        showPage('clock-in');
                    } catch (error) {
                        console.error("Clock in error:", error);
                        showToast("æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", true);
                    } finally {
                        showLoading(false);
                    }
                });

                document.getElementById('cancel-camera-btn').addEventListener('click', close);
            }

            function applyWatermark(canvas, location, description) {
                try {
                    const context = canvas.getContext('2d');
                    const now = new Date();
                    const dateTime = now.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const name = state.currentUserData?.name || 'ä½¿ç”¨è€…';
                    const coords = location ? `${location.lat.toFixed(5)}, ${location.lng.toFixed(5)}` : 'ç„¡ä½ç½®è³‡è¨Š';
                    
                    const lines = [dateTime, name, `GPS: ${coords}`];
                    if(description) lines.push(`èªªæ˜: ${description}`);

                    context.font = '24px Arial';
                    context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    const margin = 20;
                    let y = canvas.height - margin - (lines.length - 1) * 30;

                    for (const line of lines) {
                        context.fillText(line, margin, y);
                        y += 30;
                    }
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    return dataURItoBlob(dataUrl);
                } catch (error) {
                    console.error("Error applying watermark:", error);
                    return null;
                }
            }

            function dataURItoBlob(dataURI) {
                try {
                    if (!dataURI || typeof dataURI !== 'string' || !dataURI.includes(',')) {
                        console.error("Invalid dataURI format");
                        return null;
                    }
                    
                    const byteString = atob(dataURI.split(',')[1]);
                    const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    
                    return new Blob([ab], { type: mimeString });
                } catch (error) {
                    console.error("Error converting dataURI to Blob:", error);
                    return null;
                }
            }

            // --- Google Maps ---
            function loadGoogleMapsScript() {
                if (window.google && state.googleMapsLoaded) return;
                
                // å…ˆè¨­ç½®å›èª¿å‡½æ•¸
                window.initMap = () => { 
                    state.googleMapsLoaded = true; 
                    console.log("Google Maps API å·²æˆåŠŸåŠ è¼‰");
                };
                
                // ç„¶å¾ŒåŠ è¼‰è…³æœ¬
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&v=weekly`;
                script.async = true;
                script.defer = true;
                
                // æ·»åŠ éŒ¯èª¤è™•ç†
                script.onerror = () => {
                    console.error("Google Maps API åŠ è¼‰å¤±æ•—");
                    showToast("åœ°åœ–æœå‹™åŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–APIé‡‘é‘°", true);
                };
                
                document.head.appendChild(script);
            }
            
            // --- Helper functions ---
            function cleanupListeners() {
                state.activeListeners.forEach(unsubscribe => unsubscribe());
                state.activeListeners = [];
            }

            function getStatusColor(status) {
                const colors = {'ä¸Šç­': 'text-green-600', 'ä¸‹ç­': 'text-gray-500', 'å¤–å‡º': 'text-blue-600', 'è¿”å›': 'text-teal-600'};
                return colors[status] || 'text-yellow-600';
            }

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }

            async function fetchAllUsers() {
                try {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef);
                    const querySnapshot = await getDocs(q);
                    state.users = [];
                    querySnapshot.forEach((doc) => {
                        state.users.push({ id: doc.id, ...doc.data() });
                    });
                    state.users.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
                } catch (error) {
                    console.error("Error fetching users:", error);
                    showToast("è®€å–ä½¿ç”¨è€…åˆ—è¡¨å¤±æ•—", true);
                }
            }
            
            function formatDate(timestamp) {
                if (!timestamp) return '';
                return timestamp.toDate().toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             lucide.createIcons();
             showLoading(true);
             if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY" || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                document.getElementById('api-key-warning').classList.remove('hide');
                showLoading(false);
                console.error("API Keys are not configured. Please edit index.html"); 
            } else {
                initializeAppLogic();
            }
        });
    </script>
</body>
</html>
