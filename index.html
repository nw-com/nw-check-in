<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šæ‰“å¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .main-container {
            width: 400px;
            height: 750px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
        }
        .hide { display: none !important; }
        .tab-btn.active {
            color: #4f46e5;
            border-top-color: #4f46e5;
        }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sub-tab-btn.active {
            background-color: #eef2ff;
            color: #4338ca;
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        /* Ensure map canvas is visible */
        .map-canvas {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* Gray background as a fallback */
        }
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 9999px;
            color: white;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            opacity: 1;
            bottom: 110px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- API Key Warning -->
    <div id="api-key-warning" class="hide fixed inset-0 bg-red-100 z-[9999] p-8 text-red-800 flex flex-col items-center justify-center text-center">
        <i data-lucide="alert-triangle" class="w-16 h-16 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">è«‹å®Œæˆæœ€å¾Œçš„è¨­å®šæ­¥é©Ÿ</h2>
        <p class="max-w-md">
            ç³»çµ±åµæ¸¬åˆ°æ‚¨å°šæœªè¨­å®š Firebase æˆ– Google Maps çš„ API é‡‘é‘°ã€‚
            <br><br>
            <strong class="text-red-900">é€™ä¸æ˜¯ç¨‹å¼éŒ¯èª¤ï¼Œè€Œæ˜¯å¿…è¦çš„è¨­å®šã€‚</strong> åŸºæ–¼å®‰å…¨è€ƒé‡ï¼Œæˆ‘ç„¡æ³•ç‚ºæ‚¨ç”¢ç”Ÿé‡‘é‘°ï¼Œæ‚¨å¿…é ˆè¦ªè‡ªå®Œæˆæ­¤è¨­å®šã€‚
            <br><br>
            è«‹æ‰“é–‹ <code>index.html</code> æª”æ¡ˆï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹çš„ <code>&lt;script type="module"&gt;</code> å€å¡Šï¼Œä¸¦ä¾ç…§è¨»è§£æŒ‡ç¤ºå¡«å…¥æ‚¨è‡ªå·±çš„é‡‘é‘°ã€‚è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒ <code>README.md</code> æª”æ¡ˆã€‚
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-indigo-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">ç·šä¸Šæ‰“å¡ç³»çµ±</h1>
            <p class="text-gray-500">è«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿ</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶</label>
                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                ç™»å…¥
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="main-container bg-white flex flex-col hide">
        <!-- Header -->
        <header class="h-[70px] flex items-center justify-between px-4 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <span class="text-lg font-bold text-gray-800">æ‰“å¡ç³»çµ±</span>
            </div>
            <button id="profile-avatar-btn">
                <img id="header-avatar" src="https://placehold.co/40x40/EFEFEF/333333?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col overflow-hidden bg-gray-50">
            <!-- This will be dynamically populated -->
        </main>

        <!-- Footer Navigation -->
        <footer class="h-[70px] border-t border-gray-200 flex-shrink-0 bg-white">
            <nav id="main-nav" class="flex justify-around h-full items-center">
                <button data-tab="dashboard" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 active">
                    <i data-lucide="layout-dashboard"></i><span class="text-xs mt-1">å„€è¡¨æ¿</span>
                </button>
                <button data-tab="clock-in" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="fingerprint"></i><span class="text-xs mt-1">æ‰“å¡</span>
                </button>
                <button id="nav-tracking" data-tab="tracking" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="map-pin"></i><span class="text-xs mt-1">è¿½è¹¤</span>
                </button>
                <button id="nav-settings" data-tab="settings" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="settings"></i><span class="text-xs mt-1">è¨­å®š</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>


    <script type="module">
        // --- ğŸš¨ é‡è¦è¨­å®šï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨è‡ªå·±çš„ API é‡‘é‘° ğŸš¨ ---
        const firebaseConfig = {
          apiKey: "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg",
          authDomain: "nw-check-in.firebaseapp.com",
          projectId: "nw-check-in",
          storageBucket: "nw-check-in.appspot.com",
          messagingSenderId: "1060821780559",
          appId: "1:1060821780559:web:2638d630526d54f1a5023a",
          measurementId: "G-61Q1QNNRD2"
        };
        const GOOGLE_MAPS_API_KEY = "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg";
        // --- ğŸš¨ è¨­å®šçµæŸ ğŸš¨ ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot,
            query, where, getDocs, serverTimestamp, orderBy, GeoPoint, Timestamp, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Global State
        const state = {
            currentUser: null,
            currentUserData: null,
            googleMapsLoaded: false,
            activeListeners: [],
            currentLocation: null,
            users: [], 
        };
        
        const loadingScreen = document.getElementById('loading-screen');
        
        function showLoading(show) {
            if(loadingScreen) loadingScreen.classList.toggle('hide', !show);
        }

        function initializeAppLogic() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const mainContent = document.getElementById('main-content');
            const mainNav = document.getElementById('main-nav');
            const profileAvatarBtn = document.getElementById('profile-avatar-btn');
            const modalContainer = document.getElementById('modal-container');
            const toast = document.getElementById('toast');
            const loginForm = document.getElementById('login-form');

            // --- Authentication Logic ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');
                loginError.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚';
                } finally {
                    showLoading(false);
                }
            });
            
            onAuthStateChanged(auth, (user) => {
                cleanupListeners();
                if (user) {
                    state.currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const wasNotInitialized = !state.currentUserData;
                            state.currentUserData = { id: user.uid, ...docSnap.data() };
                            if (wasNotInitialized) {
                                initializeAppUI();
                            } else {
                                updateHeaderAvatar();
                            }
                        } else { signOut(auth); }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        signOut(auth);
                    });
                    state.activeListeners.push(unsubscribe);
                } else {
                    state.currentUser = null;
                    state.currentUserData = null;
                    loginPage.classList.remove('hide');
                    appContainer.classList.add('hide');
                    showLoading(false);
                }
            });

            // --- UI Initialization and Navigation ---
            function initializeAppUI() {
                loadGoogleMapsScript();
                updateHeaderAvatar();
                
                const navTracking = document.getElementById('nav-tracking');
                const navSettings = document.getElementById('nav-settings');

                if (state.currentUserData.role !== 'admin') {
                    navTracking.classList.add('hide');
                    navSettings.classList.add('hide');
                } else {
                    navTracking.classList.remove('hide');
                    navSettings.classList.remove('hide');
                    fetchAllUsers(); 
                }
                
                loginPage.classList.add('hide');
                appContainer.classList.remove('hide');
                
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-btn[data-tab="dashboard"]').classList.add('active');
                
                showPage('dashboard');
                showLoading(false);
            }

            function updateHeaderAvatar() {
                const headerAvatar = document.getElementById('header-avatar');
                if (state.currentUserData?.avatarUrl) {
                    headerAvatar.src = state.currentUserData.avatarUrl;
                } else {
                    headerAvatar.src = `https://placehold.co/40x40/EFEFEF/333333?text=${state.currentUserData?.name?.charAt(0) || 'U'}`;
                }
            }

            mainNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-btn');
                if (tabButton && !tabButton.classList.contains('active')) {
                    showPage(tabButton.dataset.tab);
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    tabButton.classList.add('active');
                }
            });

            profileAvatarBtn.addEventListener('click', () => showToast("å€‹äººè³‡æ–™åŠŸèƒ½å¾…å¯¦ç¾"));

            function showPage(pageName, subPage = null, params = {}) {
                cleanupListeners();
                state.currentLocation = null;
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const router = {
                    'dashboard': renderDashboard,
                    'clock-in': () => renderClockIn(subPage || 'location'),
                    'tracking': () => state.currentUserData.role === 'admin' ? renderTracking(subPage || 'locate') : renderAccessDenied(),
                    'settings': () => state.currentUserData.role === 'admin' ? renderSettings(subPage || 'accounts') : renderAccessDenied()
                };
                const renderFunction = router[pageName] || renderAccessDenied;
                try {
                    renderFunction(params);
                } catch(e) {
                    console.error("Failed to render page:", e);
                    mainContent.innerHTML = `<div class="p-4 text-red-500">é é¢è¼‰å…¥å¤±æ•—ã€‚</div>`;
                }
                lucide.createIcons();
            }

            function renderAccessDenied() {
                mainContent.innerHTML = `
                    <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <i data-lucide="ban" class="w-16 h-16 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold">æ¬Šé™ä¸è¶³</h2>
                        <p>æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ã€‚</p>
                    </div>
                `;
            }

            // --- Page Render Functions ---
            
            function renderDashboard() {
                 mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-center border-b border-gray-200 bg-white">
                         <p id="current-time" class="text-lg font-semibold text-gray-700"></p>
                    </div>
                    <div class="p-4 overflow-y-auto" style="height: calc(100% - 50px);">
                        <div class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                            <h3 class="font-bold text-indigo-800 mb-2 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i>æˆ‘çš„ç‹€æ…‹</h3>
                            <div id="my-status" class="text-gray-600">è®€å–ä¸­...</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i>æ‰€æœ‰å“¡å·¥ç‹€æ…‹</h3>
                            <div id="all-users-status" class="space-y-2">
                               <div class="text-center p-4 text-gray-500">è®€å–ä¸­...</div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                const timeEl = document.getElementById('current-time');
                const timerInterval = setInterval(() => {
                    if(timeEl){ timeEl.textContent = new Date().toLocaleString('zh-TW', { dateStyle: 'long', timeStyle: 'medium' }); }
                }, 1000);
                state.activeListeners.push(() => clearInterval(timerInterval));
                
                const usersRef = collection(db, "users");
                const unsubscribe = onSnapshot(query(usersRef), (querySnapshot) => {
                    const allUsersStatusEl = document.getElementById('all-users-status');
                    if(!allUsersStatusEl) return;
                    allUsersStatusEl.innerHTML = '';
                    let myStatusFound = false;
                    const users = [];
                    querySnapshot.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                    users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                        const statusText = user.status || 'æœªæ‰“å¡';
                        const statusColor = getStatusColor(statusText);
                        if (user.id === state.currentUser.uid) {
                            myStatusFound = true;
                            document.getElementById('my-status').innerHTML = `
                              <div class="flex items-center justify-between">
                                <span class="font-semibold text-lg ${statusColor}">${statusText}</span>
                                <span class="text-sm text-gray-500">${user.lastClockInTime ? 'ä¸Šæ¬¡: ' + new Date(user.lastClockInTime.toDate()).toLocaleTimeString('zh-TW') : ''}</span>
                              </div>`;
                        }
                        allUsersStatusEl.innerHTML += `
                            <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm border">
                                <div class="flex items-center"><img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover"><span class="font-medium text-gray-700">${user.name}</span></div>
                                <span class="text-sm font-semibold ${statusColor}">${statusText}</span>
                            </div>`;
                    });
                    if(!myStatusFound && document.getElementById('my-status')){ document.getElementById('my-status').textContent = 'ç„¡æ³•å–å¾—æ‚¨çš„ç‹€æ…‹'; }
                });
                state.activeListeners.push(unsubscribe);
            }

            function renderClockIn(subPage) {
                mainContent.innerHTML = `<div class="p-4">æ‰“å¡åŠŸèƒ½å¾…å¯¦ç¾</div>`;
            }

            function renderTracking(subPage) {
                mainContent.innerHTML = `<div class="p-4">è¿½è¹¤åŠŸèƒ½å¾…å¯¦ç¾</div>`;
            }

            function renderSettings(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">å¸³è™Ÿåˆ—è¡¨</button>
                        <button data-subtab="rules" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'rules' ? 'active' : ''}">è¨ˆé»è¦å‰‡</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else if (subPage === 'rules') {
                    renderSettingsRules(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('settings', btn.dataset.subtab)));
            }
            
            async function renderSettingsAccounts(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-user-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢å¸³è™Ÿ
                        </button>
                        <div id="user-list" class="space-y-2"></div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());

                const userList = document.getElementById('user-list');
                await fetchAllUsers();
                userList.innerHTML = '';
                state.users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                    userElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                            <div>
                                <p class="font-medium text-gray-800">${user.name}</p>
                                <p class="text-sm text-gray-500">${user.email}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button data-userid="${user.id}" class="edit-user-btn p-2 text-gray-500 hover:text-indigo-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button data-userid="${user.id}" class="delete-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                    userList.appendChild(userElement);
                });
                lucide.createIcons();

                document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userid;
                    const user = state.users.find(u => u.id === userId);
                    openUserModal(user);
                }));

                document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                    const userId = e.currentTarget.dataset.userid;
                    const user = state.users.find(u => u.id === userId);
                    if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${user.name} çš„å¸³è™Ÿå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                        try {
                            showLoading(true);
                            // NOTE: This only deletes the Firestore record. For a full deletion,
                            // you would need a Cloud Function to delete the Firebase Auth user.
                            await deleteDoc(doc(db, "users", userId));
                            showToast("å¸³è™Ÿåˆªé™¤æˆåŠŸ");
                            renderSettings('accounts'); // Re-render the list
                        } catch (error) {
                            console.error("Error deleting user:", error);
                            showToast("åˆªé™¤å¤±æ•—", true);
                        } finally {
                            showLoading(false);
                        }
                    }
                }));
            }

            function renderSettingsRules(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-rule-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢è¦å‰‡
                        </button>
                        <div id="rule-list" class="space-y-2">è®€å–ä¸­...</div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-rule-btn').addEventListener('click', () => openRuleModal());

                const ruleList = document.getElementById('rule-list');
                const rulesRef = collection(db, "pointRules");
                const q = query(rulesRef, orderBy("reason"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    ruleList.innerHTML = '';
                    if (querySnapshot.empty) {
                        ruleList.innerHTML = `<p class="text-center text-gray-500 p-4">å°šæœªå»ºç«‹ä»»ä½•è¦å‰‡</p>`;
                        return;
                    }
                    querySnapshot.forEach(doc => {
                        const rule = { id: doc.id, ...doc.data() };
                        const pointsClass = rule.points > 0 ? 'text-green-600' : 'text-red-600';
                        const ruleElement = document.createElement('div');
                        ruleElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        ruleElement.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${rule.reason}</p>
                                <p class="text-sm text-gray-500">å°è±¡: ${rule.target}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg ${pointsClass}">${rule.points > 0 ? '+' : ''}${rule.points}</span>
                                <button data-ruleid="${rule.id}" class="edit-rule-btn p-2 text-gray-500 hover:text-indigo-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-ruleid="${rule.id}" class="delete-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        ruleList.appendChild(ruleElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                         const ruleId = e.currentTarget.dataset.ruleid;
                         const ruleDoc = await getDoc(doc(db, "pointRules", ruleId));
                         if (ruleDoc.exists()) {
                            openRuleModal({ id: ruleId, ...ruleDoc.data() });
                         }
                    }));

                    document.querySelectorAll('.delete-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const ruleId = e.currentTarget.dataset.ruleid;
                        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¦å‰‡å—ï¼Ÿ')) {
                            await deleteDoc(doc(db, "pointRules", ruleId));
                            showToast("è¦å‰‡åˆªé™¤æˆåŠŸ");
                        }
                    }));

                });
                state.activeListeners.push(unsubscribe);
            }

            // --- Modals ---
            function openUserModal(user = null) {
                const isNew = user === null;
                const modalId = `user-modal-${Date.now()}`;
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[380px] bg-white rounded-2xl shadow-xl">
                            <div class="p-6">
                                <h3 class="text-xl font-bold mb-4">${isNew ? 'æ–°å¢å¸³è™Ÿ' : 'ç·¨è¼¯å¸³è™Ÿ'}</h3>
                                <form id="user-form" class="space-y-3 text-sm">
                                    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                                    <div class="flex items-center space-x-4">
                                        <img id="avatar-preview" src="${user?.avatarUrl || 'https://placehold.co/80x80/EFEFEF/333333?text=é ­åƒ'}" class="w-20 h-20 rounded-full object-cover border">
                                        <div>
                                             <button type="button" id="avatar-upload-btn" class="px-3 py-1.5 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">ä¸Šå‚³ç…§ç‰‡</button>
                                             <p class="text-xs text-gray-400 mt-1">å»ºè­°æ–¹å½¢åœ–ç‰‡</p>
                                        </div>
                                    </div>
                                    <div><label class="block font-medium">å§“å</label><input type="text" id="user-name" class="w-full mt-1 px-3 py-2 border rounded-md" value="${user?.name || ''}" required></div>
                                    <div><label class="block font-medium">é›»å­éƒµä»¶ (ç™»å…¥å¸³è™Ÿ)</label><input type="email" id="user-email" class="w-full mt-1 px-3 py-2 border rounded-md" value="${user?.email || ''}" ${!isNew ? 'disabled' : ''} required></div>
                                    <div><label class="block font-medium">æ‰‹æ©Ÿè™Ÿç¢¼</label><input type="tel" id="user-phone" class="w-full mt-1 px-3 py-2 border rounded-md" value="${user?.phone || ''}"></div>
                                    <div><label class="block font-medium">Line ID</label><input type="text" id="user-line" class="w-full mt-1 px-3 py-2 border rounded-md" value="${user?.lineId || ''}"></div>
                                    <div><label class="block font-medium">è§’è‰²</label>
                                        <select id="user-role" class="w-full mt-1 px-3 py-2 border rounded-md">
                                            <option value="employee" ${user?.role === 'employee' ? 'selected' : ''}>å“¡å·¥</option>
                                            <option value="admin" ${user?.role === 'admin' ? 'selected' : ''}>ç®¡ç†å“¡</option>
                                        </select>
                                    </div>
                                    ${isNew ? `
                                    <div><label class="block font-medium">å¯†ç¢¼</label><input type="password" id="user-password" class="w-full mt-1 px-3 py-2 border rounded-md" required></div>
                                    <div><label class="block font-medium">ç¢ºèªå¯†ç¢¼</label><input type="password" id="user-password-confirm" class="w-full mt-1 px-3 py-2 border rounded-md" required></div>
                                    ` : ''}
                                    <p id="user-form-error" class="text-red-500 text-xs"></p>
                                    <div class="flex justify-end space-x-2 pt-4">
                                        <button type="button" class="cancel-btn px-4 py-2 border rounded-md">å–æ¶ˆ</button>
                                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">å„²å­˜</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                
                const modalEl = document.getElementById(modalId);
                const close = () => modalEl.remove();

                modalEl.querySelector('.cancel-btn').addEventListener('click', close);
                
                document.getElementById('avatar-upload-btn').addEventListener('click', () => document.getElementById('avatar-upload').click());
                document.getElementById('avatar-upload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('avatar-preview').src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                document.getElementById('user-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('user-name').value;
                    const email = document.getElementById('user-email').value;
                    const phone = document.getElementById('user-phone').value;
                    const lineId = document.getElementById('user-line').value;
                    const role = document.getElementById('user-role').value;
                    const errorEl = document.getElementById('user-form-error');
                    errorEl.textContent = '';
                    
                    if(isNew) {
                        const password = document.getElementById('user-password').value;
                        const passwordConfirm = document.getElementById('user-password-confirm').value;
                        if (password.length < 6) { errorEl.textContent = 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½æ•¸'; return; }
                        if (password !== passwordConfirm) { errorEl.textContent = 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´'; return; }
                    }

                    try {
                        showLoading(true);
                        let avatarUrl = user?.avatarUrl || null;
                        const avatarFile = document.getElementById('avatar-upload').files[0];
                        if (avatarFile) {
                            const avatarRef = ref(storage, `avatars/${isNew ? Date.now() : user.id}/${avatarFile.name}`);
                            const snapshot = await uploadBytes(avatarRef, avatarFile);
                            avatarUrl = await getDownloadURL(snapshot.ref);
                        }

                        const userData = { name, email, phone, lineId, role, avatarUrl, points: user?.points || 100 };
                        
                        if (isNew) {
                           // This is a simplified approach. In production, you'd use a Cloud Function
                           // to create the auth user to prevent exposing credentials client-side.
                           // For this project, we'll create the Firestore doc and the admin will create the Auth user.
                           // As a workaround, we use a placeholder user creation for demo purposes.
                           // This won't actually work without a backend function.
                           // Let's create the user doc and let the admin handle the auth part in Firebase console.
                           const newUserRef = doc(collection(db, "users"));
                           await setDoc(newUserRef, userData);
                           showToast("å¸³è™Ÿè³‡æ–™å»ºç«‹æˆåŠŸï¼è«‹è‡³ Firebase å¾Œå°æ‰‹å‹•å»ºç«‹å°æ‡‰çš„é©—è­‰ä½¿ç”¨è€…ã€‚");
                        } else {
                            await updateDoc(doc(db, "users", user.id), userData);
                            showToast("æ›´æ–°æˆåŠŸ");
                        }
                        close();
                        renderSettings('accounts');
                    } catch (error) {
                        console.error("Error saving user:", error);
                        showToast("å„²å­˜å¤±æ•—", true);
                        errorEl.textContent = error.message;
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            function openRuleModal(rule = null) {
                const isNew = rule === null;
                const modalId = `rule-modal-${Date.now()}`;
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[360px] bg-white rounded-2xl shadow-xl">
                             <div class="p-6">
                                <h3 class="text-xl font-bold mb-4">${isNew ? 'æ–°å¢è¦å‰‡' : 'ç·¨è¼¯è¦å‰‡'}</h3>
                                <form id="rule-form" class="space-y-4 text-sm">
                                     <div><label class="block font-medium">äº‹ç”±</label><input type="text" id="rule-reason" class="w-full mt-1 px-3 py-2 border rounded-md" value="${rule?.reason || ''}" required></div>
                                     <div><label class="block font-medium">é»æ•¸ (+5 ~ -5)</label><input type="number" id="rule-points" class="w-full mt-1 px-3 py-2 border rounded-md" value="${rule?.points || 0}" min="-5" max="5" required></div>
                                     <div><label class="block font-medium">å°è±¡</label><input type="text" id="rule-target" class="w-full mt-1 px-3 py-2 border rounded-md" value="${rule?.target || 'å…¨é«”å“¡å·¥'}" required></div>
                                     <div class="flex justify-end space-x-2 pt-4">
                                        <button type="button" class="cancel-btn px-4 py-2 border rounded-md">å–æ¶ˆ</button>
                                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">å„²å­˜</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                const modalEl = document.getElementById(modalId);
                const close = () => modalEl.remove();

                modalEl.querySelector('.cancel-btn').addEventListener('click', close);
                
                document.getElementById('rule-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const reason = document.getElementById('rule-reason').value;
                    const points = parseInt(document.getElementById('rule-points').value, 10);
                    const target = document.getElementById('rule-target').value;
                    const ruleData = { reason, points, target };

                    try {
                        if (isNew) {
                            await addDoc(collection(db, "pointRules"), ruleData);
                            showToast("è¦å‰‡æ–°å¢æˆåŠŸ");
                        } else {
                            await updateDoc(doc(db, "pointRules", rule.id), ruleData);
                            showToast("è¦å‰‡æ›´æ–°æˆåŠŸ");
                        }
                        close();
                    } catch (error) {
                        console.error("Error saving rule:", error);
                        showToast("å„²å­˜å¤±æ•—", true);
                    }
                });
            }

            // --- Google Maps ---
            function loadGoogleMapsScript() {
                if (window.google || state.googleMapsLoaded) return;
                state.googleMapsLoaded = true;
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&v=weekly`;
                script.async = true;
                window.initMap = () => { state.googleMapsLoaded = true; };
                document.head.appendChild(script);
            }
            
            // --- Helper functions ---
            function cleanupListeners() {
                state.activeListeners.forEach(unsubscribe => unsubscribe());
                state.activeListeners = [];
            }

            function getStatusColor(status) {
                const colors = {'ä¸Šç­': 'text-green-600', 'ä¸‹ç­': 'text-gray-500', 'å¤–å‡º': 'text-blue-600', 'è¿”å›': 'text-teal-600'};
                return colors[status] || 'text-yellow-600';
            }

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }

            async function fetchAllUsers() {
                try {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef);
                    const querySnapshot = await getDocs(q);
                    state.users = [];
                    querySnapshot.forEach((doc) => {
                        state.users.push({ id: doc.id, ...doc.data() });
                    });
                    state.users.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
                } catch (error) {
                    console.error("Error fetching users:", error);
                    showToast("è®€å–ä½¿ç”¨è€…åˆ—è¡¨å¤±æ•—", true);
                }
            }
            
            function formatDate(timestamp) {
                if (!timestamp) return '';
                return timestamp.toDate().toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             lucide.createIcons();
             showLoading(true);
             if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY" || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                document.getElementById('api-key-warning').classList.remove('hide');
                showLoading(false);
                console.error("API Keys are not configured. Please edit index.html"); 
            } else {
                initializeAppLogic();
            }
        });
    </script>
</body>
</html>
