<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šæ‰“å¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .main-container {
            width: 400px;
            height: 750px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
        }
        .hide { display: none !important; }
        .tab-btn.active {
            color: #4f46e5;
            border-top-color: #4f46e5;
        }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sub-tab-btn.active {
            background-color: #eef2ff;
            color: #4338ca;
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        /* Ensure map canvas is visible */
        .map-canvas {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* Gray background as a fallback */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- API Key Warning -->
    <div id="api-key-warning" class="hide fixed inset-0 bg-red-100 z-[9999] p-8 text-red-800 flex flex-col items-center justify-center text-center">
        <i data-lucide="alert-triangle" class="w-16 h-16 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">è«‹å®Œæˆæœ€å¾Œçš„è¨­å®šæ­¥é©Ÿ</h2>
        <p class="max-w-md">
            ç³»çµ±åµæ¸¬åˆ°æ‚¨å°šæœªè¨­å®š Firebase æˆ– Google Maps çš„ API é‡‘é‘°ã€‚
            <br><br>
            <strong class="text-red-900">é€™ä¸æ˜¯ç¨‹å¼éŒ¯èª¤ï¼Œè€Œæ˜¯å¿…è¦çš„è¨­å®šã€‚</strong> åŸºæ–¼å®‰å…¨è€ƒé‡ï¼Œæˆ‘ç„¡æ³•ç‚ºæ‚¨ç”¢ç”Ÿé‡‘é‘°ï¼Œæ‚¨å¿…é ˆè¦ªè‡ªå®Œæˆæ­¤è¨­å®šã€‚
            <br><br>
            è«‹æ‰“é–‹ <code>index.html</code> æª”æ¡ˆï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹çš„ <code>&lt;script type="module"&gt;</code> å€å¡Šï¼Œä¸¦ä¾ç…§è¨»è§£æŒ‡ç¤ºå¡«å…¥æ‚¨è‡ªå·±çš„é‡‘é‘°ã€‚è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒ <code>README.md</code> æª”æ¡ˆã€‚
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-indigo-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">ç·šä¸Šæ‰“å¡ç³»çµ±</h1>
            <p class="text-gray-500">è«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿ</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶</label>
                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                ç™»å…¥
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="main-container bg-white flex flex-col hide">
        <!-- Header -->
        <header class="h-[70px] flex items-center justify-between px-4 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <span class="text-lg font-bold text-gray-800">æ‰“å¡ç³»çµ±</span>
            </div>
            <button id="profile-avatar-btn">
                <img id="header-avatar" src="https://placehold.co/40x40/EFEFEF/333333?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col overflow-hidden bg-gray-50">
            <!-- This will be dynamically populated -->
        </main>

        <!-- Footer Navigation -->
        <footer class="h-[70px] border-t border-gray-200 flex-shrink-0 bg-white">
            <nav id="main-nav" class="flex justify-around h-full items-center">
                <button data-tab="dashboard" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 active">
                    <i data-lucide="layout-dashboard"></i><span class="text-xs mt-1">å„€è¡¨æ¿</span>
                </button>
                <button data-tab="clock-in" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="fingerprint"></i><span class="text-xs mt-1">æ‰“å¡</span>
                </button>
                <button id="nav-tracking" data-tab="tracking" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="map-pin"></i><span class="text-xs mt-1">è¿½è¹¤</span>
                </button>
                <button id="nav-settings" data-tab="settings" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="settings"></i><span class="text-xs mt-1">è¨­å®š</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>


    <script type="module">
        // --- ğŸš¨ é‡è¦è¨­å®šï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨è‡ªå·±çš„ API é‡‘é‘° ğŸš¨ ---
        //
        // æ‚¨çœ‹åˆ°çš„éŒ¯èª¤è¨Šæ¯ "Error: API Keys are not configured" æ˜¯æ­£å¸¸çš„æé†’ï¼Œä¸¦éç¨‹å¼ bugã€‚
        // é€™å€‹æ‡‰ç”¨ç¨‹å¼éœ€è¦é€£æ¥åˆ° Google Firebase å’Œ Google Maps æœå‹™æ‰èƒ½é‹ä½œã€‚
        // æ‚¨å¿…é ˆè¦ªè‡ªå‰å¾€é€™å…©å€‹æœå‹™çš„å®˜æ–¹ç¶²ç«™ï¼Œå»ºç«‹æ‚¨è‡ªå·±çš„å°ˆæ¡ˆä¸¦å–å¾—é‡‘é‘°ã€‚
        //
        // 1. å‰å¾€ Firebase å®˜æ–¹ç¶²ç«™å»ºç«‹å°ˆæ¡ˆï¼Œåœ¨å°ˆæ¡ˆè¨­å®šä¸­å–å¾—æ‚¨çš„ `firebaseConfig` ç‰©ä»¶ã€‚
        // 2. å‰å¾€ Google Cloud Platform å»ºç«‹å°ˆæ¡ˆï¼Œå•Ÿç”¨ "Maps JavaScript API" ä¸¦å–å¾—æ‚¨çš„ API é‡‘é‘°ã€‚
        // 3. å°‡ä¸‹æ–¹ "YOUR_..." çš„éƒ¨åˆ†ï¼Œå®Œæ•´æ›¿æ›æˆæ‚¨è‡ªå·±çš„é‡‘é‘°å’Œè¨­å®šè³‡è¨Šã€‚
        //
        // å¦‚æœä¸åŸ·è¡Œæ­¤æ­¥é©Ÿï¼Œæ‡‰ç”¨ç¨‹å¼å°‡ç„¡æ³•å•Ÿå‹•ã€‚è©³ç´°æ•™å­¸è«‹åƒè€ƒ README.md æª”æ¡ˆã€‚
        //
        const firebaseConfig = {
          apiKey: "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg",
          authDomain: "nw-check-in.firebaseapp.com",
          projectId: "nw-check-in",
          storageBucket: "nw-check-in.appspot.com",
          messagingSenderId: "1060821780559",
          appId: "1:1060821780559:web:2638d630526d54f1a5023a",
          measurementId: "G-61Q1QNNRD2"
        };

        const GOOGLE_MAPS_API_KEY = "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg"; // <-- æ›¿æ›é€™è£¡
        // --- ğŸš¨ è¨­å®šçµæŸ ğŸš¨ ---

        // --- Configuration Check ---
        if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY" || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
            document.getElementById('api-key-warning').classList.remove('hide');
            document.getElementById('loading-screen').classList.add('hide');
            lucide.createIcons();
            // This error is intentional to stop execution if keys aren't set.
            throw new Error("API Keys are not configured. Please edit index.html");
        }

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot,
            query, where, getDocs, serverTimestamp, orderBy, GeoPoint, Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global State
        let currentUser = null;
        let currentUserData = null;
        let googleMapsLoaded = false;
        let activeListeners = []; // To store unsubscribe functions

        // Page and Element References
        const loadingScreen = document.getElementById('loading-screen');
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const mainNav = document.getElementById('main-nav');
        const profileAvatarBtn = document.getElementById('profile-avatar-btn');
        const modalContainer = document.getElementById('modal-container');

        // --- Authentication Logic ---
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚';
            } finally {
                showLoading(false);
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            cleanupListeners();
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const wasNotInitialized = !currentUserData;
                        currentUserData = { id: user.uid, ...docSnap.data() };
                        if (wasNotInitialized) {
                            initializeAppUI();
                            loginPage.classList.add('hide');
                            appContainer.classList.remove('hide');
                            showLoading(false);
                        } else {
                            updateHeaderAvatar();
                        }
                    } else {
                        signOut(auth);
                    }
                });
                activeListeners.push(unsubscribe);
            } else {
                currentUser = null;
                currentUserData = null;
                loginPage.classList.remove('hide');
                appContainer.classList.add('hide');
                showLoading(false);
            }
        });

        // --- UI Initialization and Navigation ---
        function initializeAppUI() {
            loadGoogleMapsScript();
            updateHeaderAvatar();
            const navTracking = document.getElementById('nav-tracking');
            const navSettings = document.getElementById('nav-settings');
            if (currentUserData.role !== 'admin') {
                navTracking.classList.add('hide');
                navSettings.classList.add('hide');
            } else {
                navTracking.classList.remove('hide');
                navSettings.classList.remove('hide');
            }
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn[data-tab="dashboard"]').classList.add('active');
            showPage('dashboard');
        }

        function updateHeaderAvatar() {
            const headerAvatar = document.getElementById('header-avatar');
            if (currentUserData?.avatarUrl) {
                headerAvatar.src = currentUserData.avatarUrl;
            } else {
                headerAvatar.src = `https://placehold.co/40x40/EFEFEF/333333?text=${currentUserData?.name?.charAt(0) || 'U'}`;
            }
        }

        mainNav.addEventListener('click', (e) => {
            const tabButton = e.target.closest('.tab-btn');
            if (tabButton && !tabButton.classList.contains('active')) {
                showPage(tabButton.dataset.tab);
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                tabButton.classList.add('active');
            }
        });

        profileAvatarBtn.addEventListener('click', () => {
            // Will be implemented later
        });

        function showPage(pageName, subPage = null, params = {}) {
            cleanupListeners();
            mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
            const router = {
                'dashboard': renderDashboard,
                'clock-in': () => renderClockIn(subPage || 'location'),
                'tracking': () => currentUserData.role === 'admin' ? renderTracking(subPage || 'locate') : renderAccessDenied(),
                'settings': () => currentUserData.role === 'admin' ? renderSettings(subPage || 'accounts') : renderAccessDenied()
            };
            const renderFunction = router[pageName] || renderAccessDenied;
            renderFunction(params);
            lucide.createIcons();
        }

        function renderAccessDenied() {
            mainContent.innerHTML = `
                <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                    <i data-lucide="ban" class="w-16 h-16 mx-auto mb-4"></i>
                    <h2 class="text-xl font-bold">æ¬Šé™ä¸è¶³</h2>
                    <p>æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ã€‚</p>
                </div>
            `;
            lucide.createIcons();
        }

        // --- Page Render Functions ---
        
        function renderDashboard() {
            mainContent.innerHTML = `
                <div class="h-[50px] flex items-center justify-center border-b border-gray-200 bg-white">
                     <p id="current-time" class="text-lg font-semibold text-gray-700"></p>
                </div>
                <div class="p-4 overflow-y-auto" style="height: calc(100% - 50px);">
                    <div class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                        <h3 class="font-bold text-indigo-800 mb-2 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i>æˆ‘çš„ç‹€æ…‹</h3>
                        <div id="my-status" class="text-gray-600">è®€å–ä¸­...</div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i>æ‰€æœ‰å“¡å·¥ç‹€æ…‹</h3>
                        <div id="all-users-status" class="space-y-2">
                           <div class="text-center p-4 text-gray-500">è®€å–ä¸­...</div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            const timeEl = document.getElementById('current-time');
            const timerInterval = setInterval(() => {
                if(timeEl){ timeEl.textContent = new Date().toLocaleString('zh-TW', { dateStyle: 'long', timeStyle: 'medium' }); }
            }, 1000);
            activeListeners.push(() => clearInterval(timerInterval));
            const usersRef = collection(db, "users");
            const unsubscribe = onSnapshot(query(usersRef), (querySnapshot) => {
                const allUsersStatusEl = document.getElementById('all-users-status');
                if(!allUsersStatusEl) return;
                allUsersStatusEl.innerHTML = '';
                let myStatusFound = false;
                const users = [];
                querySnapshot.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                    const statusText = user.status || 'æœªæ‰“å¡';
                    const statusColor = getStatusColor(statusText);
                    if (user.id === currentUser.uid) {
                        myStatusFound = true;
                        document.getElementById('my-status').innerHTML = `
                          <div class="flex items-center justify-between">
                            <span class="font-semibold text-lg ${statusColor}">${statusText}</span>
                            <span class="text-sm text-gray-500">${user.lastClockInTime ? 'ä¸Šæ¬¡: ' + new Date(user.lastClockInTime.toDate()).toLocaleTimeString('zh-TW') : ''}</span>
                          </div>`;
                    }
                    allUsersStatusEl.innerHTML += `
                        <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm border">
                            <div class="flex items-center"><img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover"><span class="font-medium text-gray-700">${user.name}</span></div>
                            <span class="text-sm font-semibold ${statusColor}">${statusText}</span>
                        </div>`;
                });
                if(!myStatusFound && document.getElementById('my-status')){ document.getElementById('my-status').textContent = 'ç„¡æ³•å–å¾—æ‚¨çš„ç‹€æ…‹'; }
            });
            activeListeners.push(unsubscribe);
        }

        function renderClockIn(subPage) {
            mainContent.innerHTML = `
                <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                    <button data-subtab="location" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'location' ? 'active' : ''}">å®šä½æ‰“å¡</button>
                    <button data-subtab="records" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'records' ? 'active' : ''}">æ‰“å¡ç´€éŒ„</button>
                </div>
                <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
            
            const subPageContent = document.getElementById('sub-page-content');
            if (subPage === 'location') {
                subPageContent.innerHTML = `
                    <div class="p-4 h-full flex flex-col">
                        <button id="relocate-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 flex items-center justify-center mb-4">
                            <i data-lucide="locate-fixed" class="w-4 h-4 mr-2"></i>é‡æ–°å®šä½
                        </button>
                        <div id="map-container" class="flex-grow rounded-lg overflow-hidden border border-gray-300 relative">
                             <div id="map" class="map-canvas"></div>
                             <div id="map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-4">
                            <button data-type="ä¸Šç­" class="clock-in-btn bg-green-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-green-600">ä¸Šç­æ‰“å¡</button>
                            <button data-type="ä¸‹ç­" class="clock-in-btn bg-gray-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-gray-600">ä¸‹ç­æ‰“å¡</button>
                            <button data-type="å¤–å‡º" class="clock-in-btn bg-blue-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-600">å¤–å‡ºæ‰“å¡</button>
                            <button data-type="è¿”å›" class="clock-in-btn bg-teal-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-teal-600">è¿”å›æ‰“å¡</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initClockInMap();
                document.getElementById('relocate-btn').addEventListener('click', initClockInMap);
                document.querySelectorAll('.clock-in-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.target.dataset.type;
                        // Trigger camera modal, then save record
                        alert(`è§¸ç™¼ ${type} æ‰“å¡æµç¨‹ (åŠŸèƒ½å¾…å¯¦ç¾)`);
                    });
                });
            } else if (subPage === 'records') {
                subPageContent.innerHTML = `<div class="p-4"><p>æ‰“å¡ç´€éŒ„åŠŸèƒ½å¾…å¯¦ç¾</p></div>`;
            }
            mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => renderClockIn(btn.dataset.subtab)));
        }

        async function initClockInMap() {
            if (!googleMapsLoaded) {
                setTimeout(initClockInMap, 200);
                return;
            }
            const mapLoader = document.getElementById('map-loader');
            const mapDiv = document.getElementById('map');
            if(!mapDiv || !mapLoader) return;
            mapLoader.classList.remove('hide');

            try {
                const pos = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
                });
                const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                const map = new google.maps.Map(mapDiv, { center: coords, zoom: 17, disableDefaultUI: true });
                new google.maps.Marker({ position: coords, map: map });
                mapLoader.classList.add('hide');
            } catch (error) {
                console.error("Error getting location:", error);
                mapDiv.innerHTML = `<div class="p-4 text-center text-red-500">ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™ã€‚</div>`;
                mapLoader.classList.add('hide');
            }
        }

        function renderTracking(subPage) {
            mainContent.innerHTML = `
                <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white text-sm">
                    <button data-subtab="locate" class="sub-tab-btn px-3 py-2 rounded-md font-medium text-gray-600 ${subPage === 'locate' ? 'active' : ''}">å®šä½å“¡å·¥</button>
                    <button data-subtab="contact" class="sub-tab-btn px-3 py-2 rounded-md font-medium text-gray-600 ${subPage === 'contact' ? 'active' : ''}">è¯ç¹«å“¡å·¥</button>
                    <button data-subtab="records" class="sub-tab-btn px-3 py-2 rounded-md font-medium text-gray-600 ${subPage === 'records' ? 'active' : ''}">å“¡å·¥ç´€éŒ„</button>
                </div>
                <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"><div class="p-4"><p>åŠŸèƒ½å¾…å¯¦ç¾</p></div></div>`;
            mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => renderTracking(btn.dataset.subtab)));
        }

        function renderSettings(subPage) {
            mainContent.innerHTML = `
                <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                    <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">å¸³è™Ÿåˆ—è¡¨</button>
                    <button data-subtab="rules" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'rules' ? 'active' : ''}">è¨ˆé»è¦å‰‡</button>
                </div>
                <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"><div class="p-4"><p>åŠŸèƒ½å¾…å¯¦ç¾</p></div></div>`;
             mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => renderSettings(btn.dataset.subtab)));
        }

        // --- Google Maps ---
        function loadGoogleMapsScript() {
            if (window.google || googleMapsLoaded) return;
            googleMapsLoaded = true;
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&v=weekly`;
            script.async = true;
            window.initMap = () => console.log("Google Maps API loaded.");
            document.head.appendChild(script);
        }
        
        // --- Helper functions ---
        function showLoading(show) {
            loadingScreen.classList.toggle('hide', !show);
        }
        
        function cleanupListeners() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        }

        function getStatusColor(status) {
            const colors = {'ä¸Šç­': 'text-green-600', 'ä¸‹ç­': 'text-gray-500', 'å¤–å‡º': 'text-blue-600', 'è¿”å›': 'text-teal-600'};
            return colors[status] || 'text-yellow-600';
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             lucide.createIcons();
             showLoading(true);
        });
    </script>
</body>
</html>
