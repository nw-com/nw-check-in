<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TY 主頁</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold">TY 主頁</h1>
      <div class="flex items-center space-x-3">
        <span id="user-role" class="text-sm text-gray-600"></span>
        <button id="logout" class="px-3 py-1 bg-gray-200 rounded">登出</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="bg-white rounded shadow p-6">
      <h2 class="text-lg font-semibold mb-2">歡迎</h2>
      <p id="welcome" class="text-gray-700 mb-4">載入使用者資訊中...</p>

      <div id="admin-panels" class="grid md:grid-cols-3 gap-4 hidden">
        <div class="border rounded p-4">
          <h3 class="font-semibold mb-2">人員概況</h3>
          <p class="text-gray-600 text-sm">此處可擴充為管理者/人事/高階主管的儀表板。</p>
        </div>
        <div class="border rounded p-4">
          <h3 class="font-semibold mb-2">審核與通知</h3>
          <p class="text-gray-600 text-sm">可整合請假/補卡申請審核與公告。</p>
        </div>
        <div class="border rounded p-4">
          <h3 class="font-semibold mb-2">設定</h3>
          <p class="text-gray-600 text-sm">系統與規則設定入口。</p>
        </div>
      </div>

      <div id="restricted" class="hidden">
        <p class="text-gray-700">您的帳號不屬於「管理者、人事、高階主管」。</p>
        <p class="text-gray-700">請前往原系統進行「新申請與設定」。</p>
        <div class="mt-3">
          <a href="index.html" class="text-blue-600 underline">前往原系統首頁</a>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    // 與 index.html 共用同一組 Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg",
      authDomain: "nw-check-in.firebaseapp.com",
      projectId: "nw-check-in",
      storageBucket: "nw-check-in.appspot.com",
      messagingSenderId: "1060821780559",
      appId: "1:1060821780559:web:2638d630526d54f1a5023a",
      measurementId: "G-61Q1QNNRD2"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = window.__app || initializeApp(firebaseConfig);
    const auth = window.__auth || getAuth(app);
    const db = window.__db || getFirestore(app);
    window.__app = app; window.__auth = auth; window.__db = db;

    const welcome = document.getElementById('welcome');
    const adminPanels = document.getElementById('admin-panels');
    const restricted = document.getElementById('restricted');
    const roleEl = document.getElementById('user-role');
    const logoutBtn = document.getElementById('logout');

    logoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); location.href = 'ty.html'; } catch (e) { console.error(e); }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'ty.html'; return; }
      try {
        const snap = await getDoc(doc(db, 'users', user.uid));
        const data = snap.exists() ? snap.data() : {};
        const role = data.role;
        roleEl.textContent = `角色：${role || '未知'}`;
        welcome.textContent = `${data.name || user.email || '使用者'}，歡迎回來！`;
        const allowed = ['admin','hr','manager'];
        if (allowed.includes(role)) {
          adminPanels.classList.remove('hidden');
          restricted.classList.add('hidden');
        } else {
          restricted.classList.remove('hidden');
          adminPanels.classList.add('hidden');
        }
      } catch (e) {
        console.error('讀取使用者資料失敗', e);
        restricted.classList.remove('hidden');
        adminPanels.classList.add('hidden');
      }
    });
  </script>
</body>
</html>