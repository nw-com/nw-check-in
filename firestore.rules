rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 共用函式：角色與身分判斷
    function isAuthenticated() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    function isJuniorManager() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'junior_manager';
    }
    // 限制一般用戶可更新的 users 欄位（避免權限提升與敏感欄位被修改）
    function allowUserProfileFieldsOnly() {
      // 僅允許一般用戶更新這些欄位：
      // name, phone, lineId, email, avatarUrl
      return resource.data.diff(request.resource.data).changedKeys().hasOnly(
        ['name', 'phone', 'lineId', 'email', 'avatarUrl']
      );
    }
    // 僅允許本人在 firstClockInDeviceId 尚未設定時，單獨寫入一次
    function canWriteFirstDeviceIdOnce() {
      return resource.data.firstClockInDeviceId == null &&
             request.resource.data.firstClockInDeviceId != null &&
             resource.data.diff(request.resource.data).changedKeys().hasOnly(['firstClockInDeviceId']);
    }
    // 全域預設：允許所有已登入用戶讀取，但不允許任意寫入
    // 具體集合的寫入權限在下方細則中分別定義
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    // 為了讓儀表板能顯示所有員工的狀態，允許所有登入的使用者讀取所有人的基本資料。
    // 使用者仍然只能更新自己的個人資料，但管理員可以更新所有用戶資料。
    match /users/{userId} {
      // 讀取：任何登入者可讀（配合儀表板顯示所有員工狀態）
      allow read: if isAuthenticated();
      // 更新：管理員可更新所有欄位；一般用戶僅能更新非敏感欄位（避免改 role 等權限欄位）
      allow update: if isAdmin() || (isOwner(userId) && (allowUserProfileFieldsOnly() || canWriteFirstDeviceIdOnce()));
      // 建立／刪除：僅管理員
      allow create, delete: if isAdmin();
    }
    
    // 允許所有登入的使用者讀取所有人的打卡紀錄。
    // 注意：Firestore 的讀取權限是針對整個文件，無法只開放部分欄位。
    // 使用者仍然只能為自己建立打卡紀錄。
    match /clockInRecords/{recordId} {
      // 允許使用者為自己建立打卡紀錄；管理員可為任一用戶建立（自動下班等）
      allow create: if isOwner(request.resource.data.userId) || isAdmin();
      allow read: if isAuthenticated();
      // 為確保紀錄的完整性，不允許更新或刪除
      allow update, delete: if false;
    }
    
    // 只有管理員可以讀寫計點規則
    match /pointRules/{ruleId} {
      allow read, write: if isAdmin();
    }
    
    // 允許用戶和管理員上傳和更新大頭照
    match /userAvatars/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // 允許用戶提交請假申請，並允許管理員審核
    match /leaves/{leaveId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      // 使用者可取消自己待審核的請假（僅 pending -> canceled）
      allow update: if (
        // 管理員可更新任意請假申請
        isAdmin()
      ) || (
        // 本人可將自己提交且為 pending 的假單取消（更新為 canceled）
        request.auth.uid == resource.data.userId &&
        resource.data.status == 'pending' &&
        request.resource.data.status == 'canceled' &&
        request.resource.data.keys().hasOnly(['status', 'canceledAt'])
      );
      allow delete: if false;
    }
    
    // 允許用戶提交特殊勤務申請，並允許管理員審核
    match /specialDuties/{dutyId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      // 允許管理員更新特殊勤務申請狀態（審核功能）
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // 允許讀取所有人員狀態資訊（用於人員地圖和追蹤功能）
    match /userStatus/{userId} {
      allow read: if isAuthenticated();
      allow create, update: if isOwner(userId) || isAdmin();
      allow delete: if false;
    }

    // 設定資料：general 與 group
    // general：任何登入者可讀，僅管理員可寫
    match /settings/general {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // group：供群組頁載入指定可見成員名單
    // 管理員與初階主管可讀，僅管理員可寫
    match /settings/group {
      allow read: if isAdmin() || isJuniorManager();
      allow write: if isAdmin();
    }
  }
}